<!DOCTYPE html>
<html lang="de">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reversal Learning Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>



    <div id="instruction-section">
        <video id="instruction-video" width="800" height="450" controls>
            <source src="Instruktionen_RL.mp4" type="video/mp4">
        </video>
        <button id="next-button">Weiter</button>
    </div>

    
    <div id="player-selection-section" style = "display: none;">
        <h2>Wähle einen Spieler</h2>
        <div id="players">
            <!-- Player images added dynamically -->
        </div>
        <button id="start-game-button" style="display:none;">Spiel starten</button>
    </div>

    <div id="game-section" style="display:none;">
        <div id="background">
            <img id="self-player" src="" alt="Self Player" style="position:absolute; top:20px; right:20px; width:100px;">
            <div id="card-selection">
                <h2>Kartenwahl: Wähle 2 Karten</h2>
                <div id="cards">
                    <!-- Kartenbilder werden hier per JavaScript hinzugefügt -->
                </div>
            </div>
            <div id="gameplay" style="display:none;">
                <h2>Für welche Karte entscheidest du dich?</h2>
                <div id="chosen-cards"></div>
                <div id="feedback"></div>
            </div>
        </div>
    </div>
    <script src="script.js"></script>

    <div id="scale-popup">
        <h2>Wie geht es dir gerade?</h2>
        <label>Stimmung (0 = nicht gut, 100 = sehr gut)</label>
        <input type="range" id="mood-scale" min="0" max="100" value="50">
        <span id="mood-value">50</span>
        
        <label>Aufgeregtheit (0 = gar nicht, 100 = sehr aufgeregt)</label>
        <input type="range" id="excitement-scale" min="0" max="100" value="50">
        <span id="excitement-value">50</span>
        
        <button id="submit-scale">Bestätigen</button>
    </div>
    
</body>


<style>

body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: #f0f0f0;
    margin: 0;
    overflow: hidden;
}

#instruction-section, #game-section, #player-selection-section {
    text-align: center;
}

#player-selection-section {
    text-align: center;
}

#gameplay {
    margin-top: 100px; /* Ensures cards are in the upper half */
    display: flex;
    justify-content: center;
    width: 100%;
}
#background {
    background-image: url('background.png');
    background-size: cover;
    background-position: center;
    width: 100vw;
    height: 100vh;
    display:flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    padding-top: 20px;
}

#chosen-cards {
    display:flex;
    justify-content: center;
    gap: 40px;
}

#cards img, #chosen-cards img {
    width: 100px;
    cursor: pointer;
}

#feedback img {
    width: 300px;
    height: auto;
    margin-top: 10px;
}

#next-button {
    margin-top: 10px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
}

.selected {
    border: 3px solid blue;
}

#scale-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
    display: none;
    z-index: 1000;
    text-align: center;
}

#scale-popup label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
}

#scale-popup input[type="range"] {
    width: 80%;
}

#players {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}


.player {
    width: 100px;
    cursor: pointer;
    transition: transform 0.2s;
}

.player:hover {
    transform: scale(1.1); /* Slight zoom effect on hover */
}

.player.selected {
    border: 3px solid green; /* Highlight selected player */
}


#start-game-button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
}

#self-player {
    position: absolute;
    top: 0;
    right: 0;
    width: auto; /* Maintain proportional width */
    height: 50vh; /* Cover half the screen height */
    z-index: 10; /* Ensure it doesn't overlap other elements */
}


/* Disable card interactions */
.disabled {
    pointer-events: none; /* Prevent all interactions */
    opacity: 0.5; /* Optional: Visually indicate the disabled state */
}

</style>

<script> 
// Elemente abrufen
const instructionSection = document.getElementById('instruction-section');
const playerSelectionSection = document.getElementById('player-selection-section');
const gameSection = document.getElementById('game-section');
const playersContainer = document.getElementById('players');
const startGameButton = document.getElementById('start-game-button');
const selfPlayerImage = document.getElementById('self-player');
const nextButton = document.getElementById('next-button');
const cardSelection = document.getElementById('card-selection');
const gameplay = document.getElementById('gameplay');
const cardsContainer = document.getElementById('cards');
const chosenCardsContainer = document.getElementById('chosen-cards');
const feedbackContainer = document.getElementById('feedback');

// Skalen-Popup-Elemente
const scalePopup = document.getElementById('scale-popup');
const moodScale = document.getElementById('mood-scale');
const excitementScale = document.getElementById('excitement-scale');
const moodValue = document.getElementById('mood-value');
const excitementValue = document.getElementById('excitement-value');
const submitScaleButton = document.getElementById('submit-scale');

// Konfigurationsvariablen
const cardImages = ['card1.png', 'card2.png', 'card3.png', 'card4.png', 'card5.png', 'card6.png'];
const rewardImage = 'reward.png';
const lossImage = 'loss.png';
const rewardSound = new Audio('reward.mp3'); // Load reward sound
const lossSound = new Audio('loss.mp3');     // Load loss sound
const trials = 140;
const playerImages = ['player1.png', 'player2.png', 'player3.png', 'player4.png', 'player5.png', 'player6.png'];
let selectedPlayer = null; 
let selectedCards = [];
let trialCounter = 0;
let cardSwitchInterval = 20;
let reversalIntervals = [8, 6];
let rewardProbability = 0.8;
let trialData = [];  // Array zur Speicherung der Daten
let nextFeedbackTrial = getRandomInterval();

// Configuration variables for the game
const totalTrials = 144; // Total trials
const reversalIntervalLeft = 12; // Reversal interval for the left card
const reversalIntervalRight = 24; // Reversal interval for the right card



let leftCardRewarding = true; // Left card starts rewarding
let rightCardRewarding = true; // Right card starts rewarding


// Event Listener für Weiter-Button
nextButton.addEventListener('click', showPlayerSelection);
startGameButton.addEventListener('click', startGame);

// Event Listener für Skalenwert anzeigen
moodScale.addEventListener('input', () => {
    moodValue.textContent = moodScale.value;
});

excitementScale.addEventListener('input', () => {
    excitementValue.textContent = excitementScale.value;
});

// Ensure the self-player image covers half the screen
selfPlayerImage.onload = () => {
    selfPlayerImage.style.height = '100vh'; // Set height to 50% of the viewport height
    selfPlayerImage.style.width = 'auto'; // Maintain aspect ratio
};


// Event Listener für Skalen-Popup bestätigen
submitScaleButton.addEventListener('click', () => {
    let mood = moodScale.value;
    let excitement = excitementScale.value;
    console.log(`Trial ${trialCounter}: Mood - ${mood}, Excitement - ${excitement}`);
    scalePopup.style.display = 'none'; // Skalen-Popup ausblenden
    // Spiel fortsetzen
});

document.addEventListener('DOMContentLoaded', () => {
    displayPlayerSelection();
});

function getRandomInterval() {
    return Math.floor(Math.random() * 4) + 3; // Random number between 3 and 6
}

// Functions
function showPlayerSelection() {
    instructionSection.style.display = 'none';
    playerSelectionSection.style.display = 'block';
    displayPlayerSelection();
}

function displayPlayerSelection() {
    playersContainer.innerHTML = '';
    playerImages.forEach((player, index) => {
        const img = document.createElement('img');
        img.src = player;
        img.alt = `Player ${index + 1}`;
        img.classList.add('player');
        img.dataset.playerIndex = index + 1;
        img.addEventListener('click', () => selectPlayer(img));
        playersContainer.appendChild(img);
    });
}

function selectPlayer(imgElement) {
    // Remove selection from all players
    document.querySelectorAll('.player').forEach(img => img.classList.remove('selected'));

    // Highlight the selected player
    imgElement.classList.add('selected');

    // Save the selected player index
    selectedPlayer = imgElement.dataset.playerIndex;

    // Show the "Spiel starten" button
    startGameButton.style.display = 'inline';
}
function startGame() {
    if (!selectedPlayer) return;

    playerSelectionSection.style.display = 'none';
    gameSection.style.display = 'block';

    // Update the self-player image
    selfPlayerImage.src = `player${selectedPlayer}_self.png`;


    // Start the card selection process
    displayCardSelection();

 
}


// Card selection logic
function displayCardSelection() {
    cardsContainer.innerHTML = ''; // Clear existing cards
    selectedCards = []; // Reset selected cards

    // Dynamically add cards
    cardImages.forEach((card, index) => {
        const img = document.createElement('img');
        img.src = card; // Set card image
        img.alt = `Card ${index + 1}`;
        img.classList.add('card');

        // Add click event listener for selecting/deselecting cards
        img.addEventListener('click', () => selectCard(card, img));

        cardsContainer.appendChild(img); // Add card to the container
    });
}

function selectCard(card, imgElement) {
    if (cardsContainer.classList.contains('disabled')) {
        console.log("Card selection is disabled while the question is active.");
        return; // Do nothing if cards are disabled
    }

    // Check if card is already selected
    if (selectedCards.includes(card)) {
        // Deselect card
        selectedCards = selectedCards.filter(c => c !== card); // Remove from selection
        imgElement.classList.remove('selected'); // Remove visual highlight
    } else if (selectedCards.length < 2) {
        // Select card
        selectedCards.push(card); // Add to selection
        imgElement.classList.add('selected'); // Highlight visually
    }

    // Proceed if exactly 2 cards are selected
    if (selectedCards.length === 2) {
        // Disable further card selection and prompt user feedback
        cardsContainer.classList.add('disabled');
        promptUserFeedback(); // Show feedback prompt
    }
}




// Trials starten
function startTrials() {
    gameplay.style.display = 'block';
    chosenCardsContainer.innerHTML = '';
    selectedCards.forEach(card => {
        const img = document.createElement('img');
        img.src = card;
        img.addEventListener('click', () => playTrial(card, img));
        chosenCardsContainer.appendChild(img);
    });
}



// Kartenposition wechseln
function swapCardPositions() {
    selectedCards.reverse();
    chosenCardsContainer.innerHTML = '';
    selectedCards.forEach(card => {
        const img = document.createElement('img');
        img.src = card;
        img.addEventListener('click', () => playTrial(card, img));
        chosenCardsContainer.appendChild(img);
    });
}

// Befindlichkeitsabfrage
function promptUserFeedback() {
    scalePopup.style.display = 'block'; // Skalen-Popup anzeigen
}


let gamePaused = false; 

function askContinueQuestion() {
    gamePaused = true;
    // Disable card selection during the question
    chosenCardsContainer.classList.add('disabled');

    scalePopup.innerHTML = `
        <h2>Möchtest du weiterspielen?</h2>
        <button id="yes-button">Ja</button>
        <button id="no-button">Nein</button>
    `;
    scalePopup.style.display = 'block'; // Show the question popup

    // Event listener for "Ja"
    document.getElementById('yes-button').onclick = () => {
        scalePopup.style.display = 'none'; // Hide the popup
        trialData.push({
            trial: trialCounter,
            metaQuestion: "Yes"
        }); // Record the response
        resumeGameplay(); // Continue the game
    };

    // Event listener for "Nein"
    document.getElementById('no-button').onclick = () => {
        scalePopup.style.display = 'none'; // Hide the popup
        trialData.push({
            trial: trialCounter,
            metaQuestion: "No"
        }); // Record the response
        handleNoResponse(); // Handle "No" response logic
    };
}


function handleNoResponse() {
    // Show the stop.png image
    feedbackContainer.innerHTML = '<img src="stop.png" alt="Game Stopped" style="width:300px;">';

    // Disable card selection
    chosenCardsContainer.classList.add('disabled');

    // Wait for 2 seconds to show the stop image
    setTimeout(() => {
        feedbackContainer.innerHTML = ''; // Clear the stop image

        // Optionally, resume the game logic or end the game
        resumeGameplay(); // Continue the game
    }, 10000);
}

// Function to determine if a trial is rewarding based on the card and state
function isRewarded(card) {
    if (card === 'left') {
        return leftCardRewarding ? Math.random() < rewardProbability : Math.random() >= rewardProbability;
    } else if (card === 'right') {
        return rightCardRewarding ? Math.random() < rewardProbability : Math.random() >= rewardProbability;
    }
}

// Function to handle reversals
function handleReversals() {
    if (trialCounter % reversalIntervalLeft === 0) {
        leftCardRewarding = !leftCardRewarding; // Reverse left card state
    }
    if (trialCounter % reversalIntervalRight === 0) {
        rightCardRewarding = !rightCardRewarding; // Reverse right card state
    }
}


// Utility Functions
function getRandomFeedbackInterval() {
    return Math.floor(Math.random() * 4) + 3; // Random number between 3 and 6
}

function resumeGameplay() {
    chosenCardsContainer.classList.remove('disabled');
    gamePaused = false;

    // Display the chosen cards for trial selection
    cardSelection.style.display = 'none';
    gameplay.style.display = 'block';
    chosenCardsContainer.innerHTML = '';
    selectedCards.forEach(card => {
        const img = document.createElement('img');
        img.src = card;
        img.addEventListener('click', () => playTrial(card, img));
        chosenCardsContainer.appendChild(img);
    });

    console.log('Gameplay resumed. Ready for trial selection.');
}

// Function to play a trial
function playTrial(card, imgElement) {
    trialCounter++;

    // Handle card reversals based on trial number
    handleReversals();

    const isReward = isRewarded(card);

    // Reset feedback and prepare
    feedbackContainer.innerHTML = '';
    chosenCardsContainer.childNodes.forEach(img => img.style.border = 'none');

    // Show win or loss feedback
    const feedbackImage = document.createElement('img');
    feedbackImage.src = isReward ? rewardImage : lossImage;
    feedbackContainer.appendChild(feedbackImage);

    // Play the corresponding sound
    if (isReward) {
        rewardSound.play();
    } else {
        lossSound.play();
    }

    // Highlight the chosen card
    imgElement.style.border = isReward ? '5px solid green' : '5px solid red';

    // Create trial data
    const trialDataEntry = {
        trial: trialCounter,
        chosenCard: card,
        result: isReward ? 'Reward' : 'Loss',
        leftCardRewarding: leftCardRewarding,
        rightCardRewarding: rightCardRewarding,
        metaQuestion: gamePaused ? 'No' : 'Yes' // Example field for meta-question
    };

    // Save trial data
    trialData.push(trialDataEntry);

    // Send the current trial data to the server
    saveTrialToCSV(trialDataEntry);

    // Clear feedback after a short delay
    setTimeout(() => {
        feedbackContainer.innerHTML = '';
        imgElement.style.border = 'none';

        if (trialCounter % 12 === 0) {
            promptUserFeedback(); // Ask for feedback every 12 trials
        } else if (trialCounter === totalTrials) {
            endGame(); // End the game after all trials
        } else {
            askContinueQuestion(); // Proceed with the meta-question
        }
    }, 1000); // 1-second delay
}

// Function to send individual trial data to the server
function saveTrialToCSV(trialDataEntry) {
    fetch('save_trial.php', {
        method: 'POST',
        headers: { 'Content-Type': 'json' },
        body: JSON.stringify(trialDataEntry) // Send the trial data
    })
    .then(response => response.text())
    .then(data => {
        console.log('Trial saved:', data);
    })
    .catch(error => {
        console.error('Error saving trial:', error);
    });
}


function promptUserFeedback() {
    // Pause the game
    gamePaused = true;
    chosenCardsContainer.classList.add('disabled'); // Disable card selection

    // Display the scale popup within the game container
    scalePopup.innerHTML = `
        <h2>Wie geht es dir gerade?</h2>
        <label>Stimmung (-50 = sehr schlecht, 50 = sehr gut)</label>
        <input type="range" id="mood-scale" min="-50" max="50" value="0">
        <span id="mood-value">0</span>

        <label>Aufgeregtheit (0 = gar nicht, 100 = sehr aufgeregt)</label>
        <input type="range" id="excitement-scale" min="0" max="100" value="50">
        <span id="excitement-value">50</span>

        <button id="submit-scale">Bestätigen</button>
    `;
    scalePopup.style.display = 'block';
    gameSection.appendChild(scalePopup); // Ensure popup is part of the game container

    // Update mood and excitement values dynamically
    const moodScale = document.getElementById('mood-scale');
    const excitementScale = document.getElementById('excitement-scale');
    const moodValue = document.getElementById('mood-value');
    const excitementValue = document.getElementById('excitement-value');

    moodScale.addEventListener('input', () => {
        moodValue.textContent = moodScale.value;
    });

    excitementScale.addEventListener('input', () => {
        excitementValue.textContent = excitementScale.value;
    });

    // Handle feedback submission
    document.getElementById('submit-scale').onclick = () => {
        const mood = moodScale.value;
        const excitement = excitementScale.value;

        console.log(`Mood: ${mood}, Excitement: ${excitement}`); // Log feedback

        // Save feedback data
        trialData.push({
            trial: trialCounter,
            mood: mood,
            excitement: excitement
        });

        scalePopup.style.display = 'none'; // Hide popup
        resumeGameplay(); // Proceed to trials
    };
}




// End game function remains unchanged
function endGame() {
    alert("Das Spiel ist beendet. Vielen Dank fürs Spielen!");
    console.log("Trial Data:", trialData); // Log the trial data
    location.reload();
}

function saveDataToCSV() {
    fetch('save_data.php', { // Ensure this path is correct
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(trialData) // Send the trialData array
    })
    .then(response => response.text())
    .then(data => {
        console.log('Data saved:', data);
        alert('Data has been saved successfully!');
    })
    .catch(error => {
        console.error('Error saving data:', error);
    });
}


</script>
</html>